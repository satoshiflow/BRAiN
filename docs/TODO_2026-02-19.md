# TODO Liste - 2026-02-19

**Erstellt:** 2026-02-18 01:00 Uhr
**Status:** Tasks 3.2-3.4 abgeschlossen, nÃ¤chste Schritte definiert

---

## ðŸš¨ KRITISCH: Vor allen anderen Tasks

### 0.1 Coolify Build Cache lÃ¶schen
**Problem:** Backend startet nicht trotz Fix (alter Build im Cache)

**LÃ¶sung:**
- [ ] Coolify â†’ brain-backend â†’ Configuration
- [ ] "Clear Build Cache" oder "Purge Cache"
- [ ] "Force Rebuild & Deploy"
- [ ] Logs checken: Kein `@limiter.limit` Error mehr

**Verify:**
```bash
curl https://api.brain.falklabs.de/health
# Sollte: {"status":"ok"...} zurÃ¼ckgeben (nicht 502)
```

**Zeit:** ~10 Minuten

### 0.2 Uncommitted Files aufrÃ¤umen
**Dateien die noch committed werden mÃ¼ssen:**
- [ ] `docs/TASKS_3.2-3.4_IMPLEMENTATION.md`
- [ ] `TEST_RESULTS.md`
- [ ] `backend/test_service_logic.py`

```bash
git add docs/TASKS_3.2-3.4_IMPLEMENTATION.md TEST_RESULTS.md backend/test_service_logic.py
git commit -m "docs: Add implementation docs and test results"
git push origin main
```

**Zeit:** ~5 Minuten

---

## ðŸ”¥ PRIORITÃ„T 1: Production Deployment & Testing

### 1.1 Backend Deployment verifizieren
- [ ] Backend neu deployed in Coolify (auto nach Push)
- [ ] Logs checken: Keine Errors beim Start
- [ ] Health Check: `curl https://api.brain.falklabs.de/health`

### 1.2 Cluster System API testen
```bash
# Blueprints listen
curl https://api.brain.falklabs.de/api/blueprints

# Cluster erstellen
curl -X POST https://api.brain.falklabs.de/api/clusters \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "blueprint_id": "marketing-v1",
    "name": "Test Marketing Cluster",
    "type": "department",
    "target_workers": 3
  }'

# Hierarchie abrufen
curl https://api.brain.falklabs.de/api/clusters/{id}/hierarchy

# Scaling testen
curl -X POST https://api.brain.falklabs.de/api/clusters/{id}/scale \
  -H "Authorization: Bearer {token}" \
  -d '{"target_workers": 10}'
```

**Akzeptanzkriterien:**
- [ ] Alle Endpoints antworten (kein 404/501)
- [ ] Cluster kann erstellt werden
- [ ] Hierarchie wird korrekt zurÃ¼ckgegeben
- [ ] Scaling funktioniert

**Zeit:** ~30 Minuten

---

## ðŸ”´ PRIORITÃ„T 2: Genesis Integration (Agent Spawning)

### 2.1 Genesis API analysieren
- [ ] Genesis Service Dokumentation lesen
- [ ] Genesis API Endpoints identifizieren
- [ ] Agent-Erstellungs-Workflow verstehen

**File:** `backend/app/modules/genesis/` (wenn vorhanden)

### 2.2 Spawner mit Genesis integrieren
**File:** `backend/app/modules/cluster_system/creator/spawner.py`

**Zu implementieren:**

```python
# In spawn_supervisor() und spawn_worker()
# Aktuell: Nur ClusterAgent DB-Entry
# TODO: Echten Agent via Genesis erstellen

from app.modules.genesis.service import GenesisService

async def spawn_supervisor(self, cluster_id: str, agent_def: Dict):
    # 1. Agent via Genesis erstellen
    genesis = GenesisService(self.db)
    real_agent = await genesis.create_agent(
        name=agent_def["name"],
        role=agent_def["role"],
        capabilities=agent_def["capabilities"],
        config=agent_def.get("config", {})
    )

    # 2. ClusterAgent Entry erstellen
    cluster_agent = ClusterAgent(
        id=str(uuid.uuid4()),
        cluster_id=cluster_id,
        agent_id=real_agent.id,  # Genesis Agent ID
        role=AgentRole.SUPERVISOR,
        ...
    )

    return cluster_agent
```

**Akzeptanzkriterien:**
- [ ] Genesis erstellt echten Agent
- [ ] Agent-ID wird in ClusterAgent gespeichert
- [ ] Agent kann tasks ausfÃ¼hren
- [ ] Test: Cluster mit echten Agents erstellen

**Zeit:** ~2 Stunden

---

## ðŸŸ  PRIORITÃ„T 3: Auto-Scaling Logic

### 3.1 Metrics Collection implementieren
**File:** `backend/app/modules/cluster_system/service.py`

```python
async def check_scaling_needed(self, cluster_id: str) -> Optional[int]:
    """
    Check if cluster needs scaling based on metrics.
    """
    # 1. Get latest metrics
    metrics = await self.get_metrics(cluster_id, limit=10)
    if not metrics:
        return None

    latest = metrics[0]

    # 2. Get cluster blueprint scaling config
    cluster = await self.get_cluster(cluster_id)
    blueprint = self.blueprint_loader.load_from_file(f"{cluster.blueprint_id}.yaml")
    scaling_config = blueprint.get("cluster", {}).get("scaling", {})

    metric_type = scaling_config.get("metric", "task_queue_length")
    scale_up_threshold = scaling_config.get("scale_up_threshold", 10)
    scale_down_threshold = scaling_config.get("scale_down_threshold", 2)

    # 3. Check if scaling needed
    current_workers = cluster.current_workers

    if metric_type == "task_queue_length":
        queue_length = latest.queue_length or 0

        if queue_length > scale_up_threshold and current_workers < cluster.max_workers:
            # Scale up by 20%
            return min(int(current_workers * 1.2) + 1, cluster.max_workers)

        elif queue_length < scale_down_threshold and current_workers > cluster.min_workers:
            # Scale down by 20%
            return max(int(current_workers * 0.8), cluster.min_workers)

    return None
```

**Akzeptanzkriterien:**
- [ ] Metrics werden ausgewertet
- [ ] Scale-up bei hoher Last
- [ ] Scale-down bei niedriger Last
- [ ] Cooldown-Period eingehalten

**Zeit:** ~1.5 Stunden

### 3.2 Auto-Scaling Background Task
**File:** `backend/app/workers/autoscaler.py` (neu)

```python
async def autoscale_loop():
    """Background task for auto-scaling"""
    while True:
        clusters = await get_active_clusters()

        for cluster in clusters:
            new_target = await check_scaling_needed(cluster.id)

            if new_target:
                await scale_cluster(cluster.id, new_target)

        await asyncio.sleep(60)  # Check every minute
```

**Akzeptanzkriterien:**
- [ ] Background task lÃ¤uft
- [ ] Alle aktiven Cluster werden geprÃ¼ft
- [ ] Automatisches Scaling funktioniert

**Zeit:** ~1 Stunde

---

## ðŸŸ¡ PRIORITÃ„T 4: Metrics & Monitoring

### 4.1 Metrics Collection Hook
**File:** `backend/app/modules/cluster_system/metrics.py` (neu)

```python
async def collect_cluster_metrics(cluster_id: str):
    """Collect and store cluster metrics"""
    # Get cluster agents
    agents = await get_cluster_agents(cluster_id)

    # Calculate metrics
    cpu_usage = calculate_avg_cpu(agents)
    memory_usage = calculate_avg_memory(agents)
    task_rate = get_tasks_per_minute(cluster_id)
    error_rate = get_error_rate(cluster_id)

    # Store metrics
    await record_metrics(cluster_id, {
        "cpu_usage": cpu_usage,
        "memory_usage": memory_usage,
        "tasks_per_minute": task_rate,
        "error_rate": error_rate
    })
```

**Akzeptanzkriterien:**
- [ ] Metrics werden gesammelt
- [ ] Metrics in DB gespeichert
- [ ] Grafana Dashboard (optional)

**Zeit:** ~2 Stunden

---

## ðŸŸ¢ PRIORITÃ„T 5: Chat Endpoint Fix (CRITICAL)

### 5.1 Chat Endpoint 404 Problem beheben
**Problem:** `/api/chat` zeigt 404 trotz Commit

**MÃ¶gliche Ursachen:**
1. Container nicht neu gebuildet
2. Router nicht registriert
3. Route-Konflikt

**Debug Steps:**
```bash
# 1. Routes checken
curl https://api.brain.falklabs.de/openapi.json | grep -o '"path":"[^"]*"' | sort | uniq

# 2. Backend Logs checken
# In Coolify: Container Logs anschauen

# 3. Force Rebuild
# In Coolify: "Rebuild & Restart"
```

**Akzeptanzkriterien:**
- [ ] `/api/chat/health` gibt 200 zurÃ¼ck
- [ ] `/api/chat` funktioniert
- [ ] AXE UI kann chatten

**AXE UI Test:**
```bash
# Nach erfolgreichem Deploy:
curl -X POST https://api.brain.falklabs.de/api/chat \
  -H "Content-Type: application/json" \
  -H "Origin: https://axe.brain.falklabs.de" \
  -d '{"messages": [{"role": "user", "content": "Hallo!"}]}'
```

**Browser Test:**
- [ ] https://axe.brain.falklabs.de Ã¶ffnen
- [ ] Chat-Nachricht senden
- [ ] Antwort vom LLM erhalten

**Zeit:** ~30 Minuten

---

## ðŸ“‹ OPTIONAL: Weitere Verbesserungen

### 6.1 Cluster Manifests Generator
- [ ] README.md fÃ¼r Cluster generieren
- [ ] Skills.md mit Capabilities generieren
- [ ] Manifest-Files in Storage speichern

**File:** `backend/app/modules/cluster_system/manifests/generator.py`

**Zeit:** ~1 Stunde

### 6.2 Cluster Lifecycle Automation
- [ ] Hibernation nach Idle-Time
- [ ] Destroy nach Hibernation-Duration
- [ ] Reactivation bei neuen Tasks

**Zeit:** ~2 Stunden

### 6.3 Cost Management
- [ ] Cost Tracking implementieren
- [ ] Budget Alerts
- [ ] Cost per Cluster berechnen

**Zeit:** ~1.5 Stunden

---

## ðŸ“‹ TAG 1 CHECKLISTE (2026-02-19)

**Morgens erstes (30 Min):**
- [ ] 0.1 Coolify Cache lÃ¶schen & Rebuild
- [ ] 0.2 Uncommitted Files commiten
- [ ] 1.1 Health Check: Backend lÃ¤uft
- [ ] 1.2 Cluster API testen
- [ ] 5.1 Chat Endpoint fixen & AXE UI testen

**Danach (Hauptaufgaben):**
- [ ] 2.1 Genesis API analysieren
- [ ] 2.2 Spawner mit Genesis verbinden
- [ ] 3.1 Auto-Scaling Logic implementieren

**Am Ende des Tages:**
- [ ] MEMORY.md aktualisieren
- [ ] Tageslog in `memory/2026-02-19.md` schreiben
- [ ] NÃ¤chste TODO fÃ¼r Tag 2 erstellen

---

## ðŸ“Š ZEITPLAN

**Gesamt-SchÃ¤tzung:** ~11 Stunden

**Tag 1 (Morgen - 2026-02-19):**
- âœ… PrioritÃ¤t 0: Cache lÃ¶schen + Commit (30 Min)
- âœ… PrioritÃ¤t 1: Production Testing (30 Min)
- âœ… PrioritÃ¤t 5: Chat Endpoint Fix (30 Min)
- âœ… PrioritÃ¤t 2: Genesis Integration (2h)
- âœ… PrioritÃ¤t 3.1: Auto-Scaling Logic (1.5h)
- **Total:** ~5 Stunden

**Tag 2 (2026-02-20):**
- âœ… PrioritÃ¤t 3.2: Auto-Scaling Background (1h)
- âœ… PrioritÃ¤t 4: Metrics Collection (2h)
- âœ… Optional: Manifests Generator (1h)
- **Total:** ~4 Stunden

---

## âœ… BEREITS ERLEDIGT (2026-02-18)

- âœ… Task 3.1: Database Migration (Max)
- âœ… Task 3.2: Blueprint Loader & Validator
- âœ… Task 3.3: Cluster Service (create, scale, hibernate, hierarchy)
- âœ… Task 3.4: API Endpoints (alle 14 Endpoints)
- âœ… Spawner Grundstruktur
- âœ… Test Suite (10/10 Tests)
- âœ… Blueprints Router registriert
- âœ… Committed & gepusht

**Code:** ~900 Zeilen production-ready
**Commits:** 2136831, 910bc3a

---

## ðŸŽ¯ ERFOLGSKRITERIEN

**Minimum Viable Product (MVP):**
- âœ… Cluster aus Blueprint erstellen
- âœ… Agents spawnen (mit Genesis Integration)
- âœ… Scaling funktioniert (manuell)
- âœ… Hierarchie abrufen
- âœ… API voll funktionsfÃ¤hig

**Production Ready:**
- âœ… MVP Features
- âœ… Auto-Scaling aktiv
- âœ… Metrics Collection
- âœ… Monitoring Dashboard

---

## ðŸ“ž KONTAKT

**Bei Fragen/Problemen:**
- Genesis Integration unklar? â†’ Genesis Modul Docs lesen
- API Tests fehlschlagen? â†’ Backend Logs checken
- Performance Issues? â†’ Metrics analysieren

**NÃ¤chster Review:** Nach Tag 1 (Genesis Integration)

---

## ðŸ§  WICHTIGE ERINNERUNGEN

### Vor jedem Deploy:
1. **Immer erst lokal testen:** `python -c "import main"`
2. **Keine `@limiter.limit` ohne `request` Parameter**
3. **Router in main.py registrieren nicht vergessen**
4. **Nach Push: Coolify Cache lÃ¶schen wenn Probleme**

### Debugging:
```bash
# Coolify Logs live ansehen
curl -s "http://46.224.37.114:8000/api/v1/applications" -H "Authorization: Bearer juq0nGzKcKvzOhjlfXkNct6GZmVhE9em6wrmwYXu8bb8d0e7"

# Oder direkt im Coolify Dashboard
```

### Backup / Safety:
- [ ] Datenbank-Backup vor groÃŸen Ã„nderungen
- [ ] Migrationen immer testen vor Deploy
- [ ] Feature-Branches fÃ¼r groÃŸe Changes nutzen

### Kommunikation:
- **Probleme?** â†’ Sofort logs schicken
- **Erfolge?** â†’ Kurze Status-Updates
- **Blocker?** â†’ Nicht lange warten, fragen!

---

## ðŸ“ž QUICK LINKS

| Resource | URL |
|----------|-----|
| Coolify Dashboard | http://46.224.37.114:8000 |
| Backend API | https://api.brain.falklabs.de |
| AXE UI | https://axe.brain.falklabs.de |
| n8n | https://n8n.brain.falklabs.de |
| GitHub Repo | https://github.com/satoshiflow/BRAiN |

---

**Status:** ðŸ“‹ **READY TO START**
**NÃ¤chster Task:** 0.1 Coolify Cache lÃ¶schen

ðŸš€ **GOOD LUCK MORGEN!**
