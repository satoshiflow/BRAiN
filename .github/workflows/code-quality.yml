name: Code Quality & Analytics

on:
  push:
    branches: [ main, v2, develop ]
  pull_request:
    branches: [ main, v2, develop ]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday 2 AM UTC

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for better code quality analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.txt
          pip install ruff pylint radon
      
      - name: Code complexity analysis
        continue-on-error: true
        run: |
          radon cc backend/app -a -nb || echo "Complexity analysis complete"
          radon mi backend/app -nb || echo "Maintainability index calculated"
      
      - name: Detailed linting
        continue-on-error: true
        run: |
          ruff check backend/app --statistics

  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Check Python dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.txt
          pip install pip-audit
          pip-audit || echo "Vulnerabilities found, see above"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/control_deck/package-lock.json'
      
      - name: Check JavaScript dependencies
        continue-on-error: true
        run: |
          cd frontend/control_deck
          npm audit || echo "Vulnerabilities found"
          
          cd ../axe_ui
          npm audit || echo "Vulnerabilities found"

  documentation:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for missing documentation
        run: |
          missing_docs=0
          
          # Check for README in major directories
          for dir in backend frontend/control_deck frontend/axe_ui nginx; do
            if [ ! -f "$dir/README.md" ]; then
              echo "âš ï¸  Missing: $dir/README.md"
              missing_docs=$((missing_docs + 1))
            fi
          done
          
          # Check for module docstrings (Python)
          if [ $missing_docs -gt 0 ]; then
            echo "âš ï¸  $missing_docs documentation files missing"
          else
            echo "âœ… Documentation structure looks good"
          fi

  test-coverage-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: brain_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      
      - name: Generate coverage report
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/brain_test
          REDIS_URL: redis://localhost:6379/0
          ANTHROPIC_API_KEY: sk-test-key
        run: |
          cd backend
          pytest tests/ --cov=app --cov-report=html --cov-report=json
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/htmlcov/
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('backend/.coverage'));
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸ“Š Coverage Report\n\`\`\`\n${coverage}\n\`\`\``
              });
            } catch (e) {
              console.log('Could not read coverage file');
            }
