name: Scheduled Maintenance

on:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday 3 AM UTC
  workflow_dispatch:

jobs:
  dependencies-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Check for outdated Python packages
        id: pip_check
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip pip-tools
          cd backend
          pip-compile requirements.txt --dry-run --upgrade 2>&1 | grep "=" || echo "All packages up-to-date"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check for outdated JavaScript packages
        id: npm_check
        continue-on-error: true
        run: |
          echo "=== Control Deck ==="
          cd frontend/control_deck
          npm outdated || echo "All packages up-to-date"
          
          echo "=== Axe UI ==="
          cd ../axe_ui
          npm outdated || echo "All packages up-to-date"

  docker-cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Clean up old Docker images from GitHub Container Registry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Cleaning up old Docker images..."
          # Requires GitHub CLI - available in GitHub Actions
          # gh api repos/satoshiflow/BRAiN/packages/container --paginate | \
          # jq '.[] | select(.created_at < now - 30*86400) | .id' | \
          # xargs -I {} gh api repos/satoshiflow/BRAiN/packages/container/{}/delete -X DELETE || echo "No old images to clean"
          echo "‚úÖ Cleanup scheduled (manual cleanup recommended)"

  base-images-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for base image updates
        run: |
          echo "üì¶ Checking base image versions..."
          
          # Check Python base image
          echo "Python 3.11 latest:"
          docker pull python:3.11-slim --dry-run 2>/dev/null || echo "python:3.11-slim"
          
          # Check Node.js base image
          echo "Node.js 20 latest:"
          docker pull node:20-alpine --dry-run 2>/dev/null || echo "node:20-alpine"
          
          # Check Nginx
          echo "Nginx latest:"
          docker pull nginx:1.27-alpine --dry-run 2>/dev/null || echo "nginx:1.27-alpine"
          
          echo "‚ö†Ô∏è  Update base images in Dockerfiles if newer versions available"

  security-audit-schedule:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy full scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
      
      - name: Create security report issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîí Weekly Security Audit - ${date}`,
              body: `## Security Audit Results\n\n- Trivy vulnerability scan completed\n- Check Actions logs for details\n- Please review critical vulnerabilities`,
              labels: ['security', 'maintenance']
            });

  database-backup-check:
    runs-on: ubuntu-latest
    steps:
      - name: Verify database backup strategy
        run: |
          echo "üóÑÔ∏è  Database Backup Check"
          echo "Please ensure:"
          echo "‚úì PostgreSQL data is backed up (volumes mounted)"
          echo "‚úì Backup strategy documented in DEVELOPMENT.md"
          echo "‚úì Disaster recovery plan exists"
          echo ""
          echo "In production, configure:"
          echo "- Automated backups (AWS RDS, GCP Cloud SQL, etc.)"
          echo "- Point-in-time recovery"
          echo "- Regular backup restoration tests"

  logs-and-monitoring-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify monitoring & logging setup
        run: |
          echo "üìä Monitoring & Logging Verification"
          echo ""
          echo "Configured logging:"
          grep -r "LOG_LEVEL\|logging\|logger" backend/app/core/logging.py 2>/dev/null || echo "‚ö†Ô∏è  Logging not configured"
          
          echo ""
          echo "Recommended additions:"
          echo "- Prometheus metrics export"
          echo "- ELK Stack (Elasticsearch, Logstash, Kibana)"
          echo "- New Relic or DataDog integration"
          echo "- Alert rules for critical errors"
