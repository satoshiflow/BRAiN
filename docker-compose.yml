services:
  backend:
    build:
      context: ./backend
    # Removed ports - use Traefik routing instead
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:5432/brain}
      - ENABLE_MISSION_WORKER=${ENABLE_MISSION_WORKER:-true}
      - BRAIN_EVENTSTREAM_MODE=${BRAIN_EVENTSTREAM_MODE:-required}
      - BRAIN_LOG_LEVEL=${BRAIN_LOG_LEVEL:-info}
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - coolify
    # Coolify Traefik labels - domain mapping
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${SERVICE_FQDN_BACKEND}`)"
      - "traefik.http.routers.backend.entrypoints=https"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

  control_deck:
    build:
      context: ./frontend/control_deck
    # Removed ports - use Traefik routing instead
    environment:
      - NEXT_PUBLIC_BRAIN_API_BASE=${NEXT_PUBLIC_BRAIN_API_BASE:-https://${SERVICE_FQDN_BACKEND}}
      - PORT=3000
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.control_deck.rule=Host(`${SERVICE_FQDN_CONTROL_DECK}`)"
      - "traefik.http.routers.control_deck.entrypoints=https"
      - "traefik.http.routers.control_deck.tls=true"
      - "traefik.http.services.control_deck.loadbalancer.server.port=3000"

  axe_ui:
    build:
      context: ./frontend/axe_ui
    # Removed ports - use Traefik routing instead
    environment:
      - NEXT_PUBLIC_BRAIN_API_BASE=${NEXT_PUBLIC_BRAIN_API_BASE:-https://${SERVICE_FQDN_BACKEND}}
      - PORT=3002
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.axe_ui.rule=Host(`${SERVICE_FQDN_AXE_UI}`)"
      - "traefik.http.routers.axe_ui.entrypoints=https"
      - "traefik.http.routers.axe_ui.tls=true"
      - "traefik.http.services.axe_ui.loadbalancer.server.port=3002"

networks:
  coolify:
    external: true
