services:
  backend:
    build:
      context: ./backend
    ports:
      - "8001:8000"  # Host:Container - API on port 8001
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:5432/brain}
      - ENABLE_MISSION_WORKER=${ENABLE_MISSION_WORKER:-true}
      - BRAIN_EVENTSTREAM_MODE=${BRAIN_EVENTSTREAM_MODE:-required}
      - BRAIN_LOG_LEVEL=${BRAIN_LOG_LEVEL:-info}
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - coolify  # Connect to Coolify network for infrastructure services

  control_deck:
    build:
      context: ./frontend/control_deck
    ports:
      - "3001:3000"  # Host:Container - Control Deck on port 3001
    environment:
      - NEXT_PUBLIC_BRAIN_API_BASE=${NEXT_PUBLIC_BRAIN_API_BASE:-http://localhost:8001}
      - PORT=3000
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - coolify  # Connect to Coolify network

  axe_ui:
    build:
      context: ./frontend/axe_ui
    ports:
      - "3002:3002"  # Host:Container - AXE_UI on port 3002
    environment:
      - NEXT_PUBLIC_BRAIN_API_BASE=${NEXT_PUBLIC_BRAIN_API_BASE:-http://localhost:8001}
      - PORT=3002
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - coolify  # Connect to Coolify network

# Infrastructure services (PostgreSQL, Redis, Qdrant, Ollama) are deployed
# separately in Coolify for better resource management.
# This compose file only deploys the BRAiN application services.
#
# Ports:
#   - Backend API:    8001
#   - Control Deck:   3001
#   - AXE_UI:         3002
#
# Required Environment Variables:
#   - REDIS_URL (e.g., redis://your-redis-host:6379)
#   - DATABASE_URL (e.g., postgresql://user:pass@your-postgres-host:5432/brain)

networks:
  coolify:
    external: true
    # Coolify network for accessing separate infrastructure services
